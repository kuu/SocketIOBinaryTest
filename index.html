<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
    </style>
  </head>
  <body>
    <div>
      <button>Record</button>
    </div>
    <script src="vendor/recorder.js"></script>
    <script>
      var audioContext, recorder;

      document.addEventListener('DOMContentLoaded', function () {
        initGlobal();
        initDOM();
        initAudio();
      }, false);

      function initGlobal() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
        window.URL = window.URL || window.webkitURL;
      }

      function initDOM() {
        var button = document.getElementsByTagName('button')[0];
        button.addEventListener('click', function (e) {
          record(button);
        }, false);
      }

      function initAudio() {
        try {
          audioContext = new AudioContext;
          console.log('Audio context set up.');
        } catch (e) {
          console.error('No web audio support in this browser!');
        }
        navigator.getUserMedia({audio: true}, initRecorder, function(e) {
          console.error('No live audio input: ' + e);
        });
      }

      function initRecorder(stream) {
        var input = audioContext.createMediaStreamSource(stream);
        var gain = audioContext.createGain();
        gain.gain.value = 1;
        input.connect(gain);
        gain.connect(audioContext.destination);
        recorder = new Recorder(gain);
        console.log('Recorder set up.');
      }

      function record(button) {
        if (button.innerHTML === 'Record') {
          recorder && recorder.record();
          button.innerHTML = 'Stop';
          console.log('Recording...');
        } else {
          recorder && recorder.stop();
          button.innerHTML = 'Record';
          console.log('Stopped recording.');
          recorder.clear();
        }
      }
    </script>
  </body>
</html>
