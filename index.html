<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
    </style>
  </head>
  <body>
    <div>
      <label>Available audio inputs:<select id="microphones" size="1"></select></label>
    </div>
    <div>
      <p><label>Volume (Recording) <input type="range" id="recordingVolume"></label></p>
      <p><button id="recordBtn">Record</button></p>
    </div>
    <div>
      <div id="list"></div>
      <button id="mix">Mix</button>
      <button id="play">Play</button>
      <button id="delete">Delete</button>
    </div>
    <script src="recorder.js"></script>
    <script src="player.js"></script>
    <script>
      var audioContext, recorder, inputStream, recorderGain, player, list, recorderButton;

      initGlobal();
      initDOM();
      initAudio();

      function initGlobal() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
        window.URL = window.URL || window.webkitURL;
      }

      function initDOM() {
        recorderButton = document.getElementById('recordBtn');
        recorderButton.addEventListener('click', function (e) {
          record(recorderButton);
        }, false);
        var recordingVolume = document.getElementById('recordingVolume');
        recordingVolume.addEventListener('change', function () {
          recorderGain.gain.value = recordingVolume.value * 2 / 100;
        }, false); 
        list = document.getElementById('list');
        updateList();
        var mixButton = document.getElementById('mix');
        mixButton.addEventListener('click', function () {
          doMix();
        }, false);
        var playButton = document.getElementById('play');
        playButton.addEventListener('click', function () {
          if (player) {
            var items = getSelectedItem();
            playButton.disabled = true;
            player.update(items).then(function () {
              player.play(items);
              playButton.disabled = false;
            }, function () {
              playButton.disabled = false;
            });
          }
        }, false);
        var deleteButton = document.getElementById('delete');
        deleteButton.addEventListener('click', function () {
          player && player.clear();
          var items = getSelectedItem();
          if (recorder && items && items.length > 0) {
            recorder.clear(items, function (result) {
              console.log(result);
              if (result === 'success') {
                updateList();
              }
            });
          }
        }, false);
      }

      function initAudio() {

        // Init Web Audio
        try {
          audioContext = new AudioContext;
          console.log('Audio context set up.');
        } catch (e) {
          throw new Error('No web audio support in this browser!');
        }

        // Init microphone input
        var microphones = document.getElementById('microphones');
        MediaStreamTrack.getSources(function(sources) {
          var source, item;
          for (var i = 0, il = sources.length; i < il; i++) {
            source = sources[i];
            if (source.kind === 'audio') {
              item = document.createElement('option');
              item.value = source.id;
              item.innerHTML = source.id + '';
              microphones.appendChild(item);
            }
          }
        });

        microphones.addEventListener('change', function (elem) {
          var constraints = {}, id = elem.value;
          constraints.audio = {
            optional: [{ sourceId: id}]
          };
          navigator.getUserMedia(constraints, initRecorder, function(e) {
            throw new Error('No live audio input: ' + e);
          });
        }, false);

        // Init playback.
        initPlayer();
      }

      function initPlayer() {
        player = new Player();
      }

      function initRecorder(stream) {
        var mediaStreamSource = audioContext.createMediaStreamSource(stream);
        
        // Build audio graph
        if (!recorderGain) {
          recorderGain = audioContext.createGain();
          recorderGain.connect(audioContext.destination);
          recorderGain.gain.value = 0.5;
        }
        if (inputStream) {
          inputStream.disconnect();
        }
        inputStream = convertToMono(mediaStreamSource);
        inputStream.connect(recorderGain);
        if (recorder) {
          recorder.disconnect();
        }
        recorder = new Recorder(recorderGain);
        console.log('Recorder set up.');
      }

      function record(button) {
        if (button.innerHTML === 'Record') {
          player && player.play(getSelectedItem());
          recorder && recorder.record();
          button.innerHTML = 'Stop';
          console.log('Recording...');
        } else {
          player && player.stop();
          recorder && recorder.stop();
          button.innerHTML = 'Record';
          console.log('Stopped recording.');
          recorder.save(function (result) {
            console.log(result);
            if (result === 'success') {
              updateList();
            }
          });
        }
      }

      function convertToMono(input) {
	      // make sure the source is mono - some sources will be left-side only
        var splitter = audioContext.createChannelSplitter(2);
        var merger = audioContext.createChannelMerger(2);

        input.connect(splitter);
        splitter.connect(merger, 0, 0);
        splitter.connect(merger, 0, 1);
        return merger;
      }

      function updateList() {
        function handler() {
          if(this.readyState == this.DONE) {
            if(this.status == 200 &&
              this.response != null) {
              // success!
              var arr = JSON.parse(this.response), str = '', value;
              for (var i = 0, il = arr.length; i < il; i++) {
                value = arr[i];
                str += '<label><input type="checkbox" name="item" value="' + value + '">' + value + '</label><br>';
              }
              list.innerHTML = str;
              player.update(arr).then(function () {
                recorderButton.disable = false;
              }, function () {
                recorderButton.disable = false;
              });
              recorderButton.disable = true;
            }
          }
        }

        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = handler;
        xhr.open("GET", "list");
        xhr.send();
      }

      function getSelectedItem() {
        var tList = document.getElementsByName("item"), arr = [];
        for (var i = 0, il = tList.length; i < il; i++) {
          if (tList[i].checked) {
            arr.push(tList[i].value);
          }
        }
        return arr;
      }

      function doMix() {
        function handler() {
          if (this.readyState == this.DONE) {
            if (this.status == 200 && this.response) {
              var response = JSON.parse(this.response);
              if (response.result === 'success') {
                updateList();
                return;
              }
            }
            alert('Something bad happened in mixing.');
          }
        }

        var arr = getSelectedItem();
        if (arr.length < 2) {
          alert('Choose more than two items.');
        } else {
          var xhr = new XMLHttpRequest();
          xhr.onreadystatechange = handler;
          xhr.open("POST", "/mix");
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.send(JSON.stringify({mix: arr}));
        }
      }
    </script>
  </body>
</html>
