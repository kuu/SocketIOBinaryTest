<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
    </style>
  </head>
  <body>
    <div>
      <p><label>Volume<input type="range"></label></p>
      <p><button>Record</button></p>
    </div>
    <script src="vendor/recorder.js"></script>
    <script>
      var audioContext, recorder, gain;

      initGlobal();
      initDOM();
      initAudio();

      function initGlobal() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
        window.URL = window.URL || window.webkitURL;
      }

      function initDOM() {
        var button = document.getElementsByTagName('button')[0];
        button.addEventListener('click', function (e) {
          record(button);
        }, false);
        var range = document.getElementsByTagName('input')[0];
        range.addEventListener('change', function () {
          gain.gain.value = range.value * 2 / 100;
        }, false); 
      }

      function initAudio() {
        try {
          audioContext = new AudioContext;
          console.log('Audio context set up.');
        } catch (e) {
          console.error('No web audio support in this browser!');
        }
        navigator.getUserMedia({audio: true}, initRecorder, function(e) {
          console.error('No live audio input: ' + e);
        });
      }

      function initRecorder(stream) {
        // Build audio graph
        var mediaStreamSource = audioContext.createMediaStreamSource(stream);
        var monoStreamSource = convertToMono(mediaStreamSource);
        gain = audioContext.createGain();
        monoStreamSource.connect(gain);
        gain.connect(audioContext.destination);
        gain.gain.value = 0.5;
        recorder = new Recorder(gain);
        console.log('Recorder set up.');
      }

      function record(button) {
        if (button.innerHTML === 'Record') {
          recorder && recorder.record();
          button.innerHTML = 'Stop';
          console.log('Recording...');
        } else {
          recorder && recorder.stop();
          button.innerHTML = 'Record';
          console.log('Stopped recording.');
          recorder.clear();
        }
      }

      function convertToMono(input) {
	      // make sure the source is mono - some sources will be left-side only
        var splitter = audioContext.createChannelSplitter(2);
        var merger = audioContext.createChannelMerger(2);

        input.connect(splitter);
        splitter.connect(merger, 0, 0);
        splitter.connect(merger, 0, 1);
        return merger;
      }
    </script>
  </body>
</html>
