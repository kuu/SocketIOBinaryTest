<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
    </style>
  </head>
  <body>
    <div>
      <p><label>Volume<input type="range"></label></p>
      <p><button>Record</button></p>
    </div>
    <div>
      <div id="list">
      </div>
      <button id="mix">Mix</button>
    </div>
    <script src="vendor/recorder.js"></script>
    <script>
      var audioContext, recorder, gain, list, mix;

      initGlobal();
      initDOM();
      initAudio();

      function initGlobal() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
        window.URL = window.URL || window.webkitURL;
      }

      function initDOM() {
        var button = document.getElementsByTagName('button')[0];
        button.addEventListener('click', function (e) {
          record(button);
        }, false);
        var range = document.getElementsByTagName('input')[0];
        range.addEventListener('change', function () {
          gain.gain.value = range.value * 2 / 100;
        }, false); 
        list = document.getElementById('list');
        updateList();
        mix = document.getElementById('mix');
        mix.addEventListener('click', function () {
          doMix();
        }, false);
      }

      function initAudio() {
        try {
          audioContext = new AudioContext;
          console.log('Audio context set up.');
        } catch (e) {
          console.error('No web audio support in this browser!');
        }
        navigator.getUserMedia({audio: true}, initRecorder, function(e) {
          console.error('No live audio input: ' + e);
        });
      }

      function initRecorder(stream) {
        // Build audio graph
        var mediaStreamSource = audioContext.createMediaStreamSource(stream);
        var monoStreamSource = convertToMono(mediaStreamSource);
        gain = audioContext.createGain();
        monoStreamSource.connect(gain);
        gain.connect(audioContext.destination);
        gain.gain.value = 0.5;
        recorder = new Recorder(gain);
        console.log('Recorder set up.');
      }

      function record(button) {
        if (button.innerHTML === 'Record') {
          recorder && recorder.record();
          button.innerHTML = 'Stop';
          console.log('Recording...');
        } else {
          recorder && recorder.stop();
          button.innerHTML = 'Record';
          console.log('Stopped recording.');
          recorder.clear(function (result) {
            console.log(result);
            if (result === 'success') {
              updateList();
            }
          });
        }
      }

      function convertToMono(input) {
	      // make sure the source is mono - some sources will be left-side only
        var splitter = audioContext.createChannelSplitter(2);
        var merger = audioContext.createChannelMerger(2);

        input.connect(splitter);
        splitter.connect(merger, 0, 0);
        splitter.connect(merger, 0, 1);
        return merger;
      }

      function updateList() {
        function handler() {
          if(this.readyState == this.DONE) {
            if(this.status == 200 &&
              this.response != null) {
              // success!
              var arr = JSON.parse(this.response), str = '', value;
              for (var i = 0, il = arr.length; i < il; i++) {
                value = arr[i];
                str += '<label><input type="checkbox" name="item" value="' + value + '">' + value + '</label><br>';
              }
              list.innerHTML = str;
            }
          }
        }

        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = handler;
        xhr.open("GET", "list");
        xhr.send();
      }

      function doMix() {
        var tList = document.getElementsByName("item"), arr = [];
        for (var i = 0, il = tList.length; i < il; i++) {
          if (tList[i].checked) {
            arr.push(tList[i].value);
          }
        }
        if (arr.length < 2) {
          alert('Choose more than two items.');
        } else {
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/mix");
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.send(JSON.stringify({mix: arr}));
        }
      }
    </script>
  </body>
</html>
